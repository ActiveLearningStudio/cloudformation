AWSTemplateFormatVersion: '2010-09-09'
Description: 'EKS Deployment via EC2 Instance'
Parameters:
  PublicSubnetId:
    Type: String
    Description: ID of Public Subnet
  SSHKeyPair:
    Description: Ec2 Keypair Name
    Type: AWS::EC2::KeyPair::KeyName
  VpcId:
    Type: String
  VpcCidrBlock:
    Type: String
    Description: CIDR Block for VPC
  ClusterName: 
    Type: String
    Description: Name of your managed EKS Cluster
  AmiId:
    Type: AWS::SSM::Parameter::Value<String>
    Description: ParameterStore name of the Parameter containing Ubuntu AMI
  AwsAccessKeyId:
    Type: String
    Description: AWS Access Key ID
    NoEcho: "true"
  AwsSecretAccessKey:
    Type: String
    Description: AWS Secret Access Key
    NoEcho: "true"
  # DatabaseInstanceType: 
  #   AllowedValues: 
  #     - db.t2.micro
  #     - db.t2.small
  #     - db.r3.large
  #     - db.r3.xlarge
  #     - db.r3.2xlarge
  #     - db.r3.4xlarge
  #     - db.r3.8xlarge
  #   Default: db.t2.micro
  #   Description: "The instance type to use for the database."
  #   Type: String
  # DatabasePassword: 
  #   Description: "The database admin account password."
  #   MaxLength: "41"
  #   MinLength: "8"
  #   NoEcho: "true"
  #   Type: String
  # DatabaseUsername: 
  #   AllowedPattern: "[a-zA-Z0-9]+"
  #   ConstraintDescription: "must contain only alphanumeric characters."
  #   Default: awsmaster
  #   Description: "The database admin account user name."
  #   MaxLength: "16"
  #   MinLength: "1"
  #   Type: String
  # MultiAZ: 
  #   AllowedValues: 
  #     - true
  #     - false
  #   Description: "Multi AZ setup for database"
  #   Type: String
  # PGVersion: 
  #   Default: "9.6"
  #   Description: "PostgreSQL Version"
  #   Type: String
  # PrivateSubnets:
  #   Type: String
Resources:
  Ec2Instance:
    DependsOn: EksEfsFileSystem
    Type: AWS::EC2::Instance
    Properties: 
      ImageId: !Ref AmiId
      InstanceType: t2.micro
      KeyName: !Ref SSHKeyPair
      SecurityGroupIds: 
        - !Ref Ec2SecurityGroup
      SubnetId: !Ref PublicSubnetId
      UserData: 
        Fn::Base64: 
          !Sub |
            #!/bin/bash
            apt upgrade -y && apt update -y
            apt install awscli -y
            snap install kubectl --classic
            aws configure set aws_access_key_id ${AwsAccessKeyId} --profile default 
            aws configure set aws_secret_access_key ${AwsSecretAccessKey} --profile default
            aws eks update-kubeconfig --name ${ClusterName} --region ${AWS::Region}
            git clone -b develop https://github.com/ActiveLearningStudio/curriki-eks.git
            sed 's/fs-abcdefghi/${EksEfsFileSystem}/g' curriki-eks/yamls/api.yaml
            cd curriki-eks/envs
            cp .env.client.example .env.local
            cp .env.api.example .env
            kubectl create secret generic currikidev-api-secret --from-file=.env
            kubectl create secret generic currikidev-client-secret --from-file=.env.local
            cd ~/
            kubectl apply -f curriki-eks/yamls/api.yaml
            kubectl apply -f curriki-eks/yamls/client.yaml
            curl -L https://istio.io/downloadIstio | sh -
            cd istio-1.7.3
            export PATH=$PWD/bin:$PATH
            istioctl install --set profile=demo
            kubectl label namespace default istio-injection=enabled
            cd ~/
            kubectl apply -f curriki-eks/yamls/istio.yaml
  Ec2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH Access via Port 22.
      VpcId: !Ref VpcId
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '8080'
        ToPort: '8080'
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: !Sub ${AWS::StackName}-EksDeploymentSG
  
  # DatabaseSecurityGroup: 
  #   Type: "AWS::EC2::SecurityGroup"
  #   Properties: 
  #     GroupDescription: "Postgres DB Security Group"
  #     SecurityGroupIngress: 
  #       - 
  #         CidrIp: !Ref VpcCidrBlock
  #         FromPort: "5432"
  #         IpProtocol: tcp
  #         ToPort: "5432"
  #     Tags: 
  #       - 
  #         Key: Name
  #         Value: 
  #           ? "Fn::Join"
  #           : 
  #             - "-"
  #             - 
  #               - 
  #                 Ref: ClusterName
  #               - rds
  #     VpcId: !Ref VpcId
    
  # DatabaseSubnetGroup: 
  #   Type: "AWS::RDS::DBSubnetGroup"
  #   Properties: 
  #     DBSubnetGroupDescription: "DB Subnet Group"
  #     SubnetIds: 
  #       Fn::Split:
  #       - ","
  #       - !Ref PrivateSubnets
  #     Tags: 
  #       - 
  #         Key: Name
  #         Value: "rds-db-SubnetGroup"
    
  # RDSDBInstance: 
  #   Type: "AWS::RDS::DBInstance"
  #   DeletionPolicy: Snapshot
  #   Properties: 
  #     AllocatedStorage: "20"
  #     AllowMajorVersionUpgrade: "false"
  #     AutoMinorVersionUpgrade: "true"
  #     BackupRetentionPeriod: "7"
  #     CopyTagsToSnapshot: true
  #     DBInstanceClass: 
  #       Ref: DatabaseInstanceType
  #     DBInstanceIdentifier: !Sub "${ClusterName}-rds"
  #     DBName: !Sub "${ClusterName}_rds"
  #     DBSubnetGroupName:
  #       Ref: DatabaseSubnetGroup
  #     Engine: postgres
  #     EngineVersion: 
  #       Ref: PGVersion
  #     MasterUserPassword: 
  #       Ref: DatabasePassword
  #     MasterUsername: 
  #       Ref: DatabaseUsername
  #     MultiAZ: 
  #       Ref: MultiAZ
  #     PreferredBackupWindow: "05:00-05:30"
  #     PreferredMaintenanceWindow: "mon:06:00-mon:06:30"
  #     PubliclyAccessible: false
  #     StorageType: gp2
  #     VPCSecurityGroups:
  #       - Ref: DatabaseSecurityGroup
  EksEfsFileSystem:
    Type: AWS::EFS::FileSystem
    Properties: 
      BackupPolicy: 
        Status: ENABLED
      Encrypted: true
      FileSystemTags: 
        - Key: Name
          Value: EksEfsFileSystem
      LifecyclePolicies: 
        - TransitionToIA: AFTER_30_DAYS